<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NeuroHue Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f7f8fa;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .login-container {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 320px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  .login-container img {
    width: 90px;
    margin-bottom: 10px;
  }
  h2 { color: #0d2e2f; margin-bottom: 15px; }
  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 8px;
    margin: 6px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    margin: 5px 0 10px 0;
  }
  .button {
    width: 100%;
    background-color: #0d2e2f;
    color: white;
    padding: 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .button:hover { background-color: #184647; }
  .footer { margin-top: 10px; font-size: 13px; }
  #message { color: red; font-size: 14px; margin-top: 8px; min-height: 20px; }
</style>
</head>
<body>
  <div class="login-container">
    <img src="logo.png" alt="NeuroHue Logo">
    <h2>Welcome Back</h2>

    <form id="loginForm" onsubmit="event.preventDefault(); loginUser();">
      <input type="text" id="username" placeholder="Username or email" required autocomplete="username">
      <input type="password" id="password" placeholder="Password" required autocomplete="current-password">

      <div class="options">
        <label><input type="checkbox" id="remember"> Remember Me</label>
        <a href="#">Forgot Password?</a>
      </div>

      <button class="button" type="submit">Login</button>
    </form>

    <p class="footer">Donâ€™t have an account? <a href="signup.html">Sign Up</a></p>
    <p id="message"></p>
  </div>

<script>
// storage helpers
function getStored(key) {
  return localStorage.getItem(key) ?? sessionStorage.getItem(key);
}
function storeKey(key, value, remember) {
  if (remember) {
    localStorage.setItem(key, value);
    sessionStorage.removeItem(key);
  } else {
    sessionStorage.setItem(key, value);
    localStorage.removeItem(key);
  }
}

// Parse various server response shapes to extract id/username/token
function parseAuthResult(result) {
  let userId = null;
  let username = null;
  let token = null;

  if (!result) return { userId, username, token, raw: result };

  if (result.user && typeof result.user === 'object') {
    const u = result.user;
    userId = u.id ?? u.user_id ?? u.userId ?? userId;
    username = u.username ?? u.name ?? u.email ?? username;
    token = result.access_token ?? result.token ?? u.token ?? token;
  }

  userId = userId ?? result.id ?? result.user_id ?? result.userId ?? null;
  username = username ?? result.username ?? result.name ?? result.email ?? null;
  token = token ?? result.access_token ?? result.token ?? result.authToken ?? null;

  return { userId, username, token, raw: result };
}

async function loginUser() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  const remember = document.getElementById('remember').checked;
  const msg = document.getElementById('message');

  msg.style.color = 'black';
  msg.textContent = 'Signing in...';

  const payload = { username: u, password: p };

  try {
    const response = await fetch('http://127.0.0.1:8000/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // safe JSON parse fallback
    let result = null;
    try { result = await response.json(); } catch(e) { result = null; }

    if (response.ok) {
      const parsed = parseAuthResult(result);

      // store raw result for debugging/use (under "user")
      if (result) {
        if (remember) localStorage.setItem('user', JSON.stringify(result));
        else sessionStorage.setItem('user', JSON.stringify(result));
      }

      // store token if present
      if (parsed.token) storeKey('authToken', String(parsed.token), remember);

      // store multiple user_id keys for broad compatibility
      if (parsed.userId !== null && typeof parsed.userId !== 'undefined') {
        storeKey('user_id', String(parsed.userId), remember);
        storeKey('userId', String(parsed.userId), remember);
        storeKey('userid', String(parsed.userId), remember);
      } else if (result && (result.user_id || result.id)) {
        const idVal = String(result.user_id ?? result.id);
        storeKey('user_id', idVal, remember);
        storeKey('userId', idVal, remember);
        storeKey('userid', idVal, remember);
      }

      // store username
      if (parsed.username) {
        storeKey('username', String(parsed.username), remember);
      } else if (result && result.email) {
        storeKey('username', String(result.email), remember);
      }

      msg.style.color = 'green';
      msg.textContent = 'Login successful! Redirecting...';

      // redirect to dashboard (updated)
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 700);
    } else {
      msg.style.color = 'red';
      if (result && (result.detail || result.message || result.error)) {
        msg.textContent = result.detail ?? result.message ?? result.error;
      } else {
        msg.textContent = 'Invalid username or password';
      }
    }
  } catch (err) {
    console.error('Login error', err);
    const msgEl = document.getElementById('message');
    msgEl.style.color = 'red';
    msgEl.textContent = 'Server error. Please try again later.';
  }
}

// Redirect if already logged in (checks both storages)
window.addEventListener('DOMContentLoaded', () => {
  const already = getStored('user_id') ?? getStored('userId') ?? getStored('userid');
  if (already) {
    // redirect directly to dashboard
    window.location.href = 'dashboard.html';
  }
});
</script>
</body>
</html>
