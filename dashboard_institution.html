<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NeuroHue — Dashboard</title>
<style>
  :root{
    --teal:#268ea6;
    --dark:#093c44;
    --card-bg:#ffffff;
    --muted:#f3f6f7;
    --sidebar-width:280px;
    --breakpoint:900px;
    --topbar-height:64px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: "Arial",sans-serif;
    background: #ffffff;
    color:#08343a;
    min-height:100vh;
    -webkit-font-smoothing:antialiased;
  }

  /* Topbar: FULL WIDTH fixed at top */
  .topbar{
    height:var(--topbar-height);
    background:var(--teal);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 18px;
    color:#fff;
    box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    position:fixed;
    top:0;
    left:0;
    right:0;
    z-index:120; /* above sidebar/backdrop and content */
  }
  .brand {
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:700;
  }
  .brand img{ height:34px; width:34px; border-radius:6px; object-fit:cover }
  .brand .title { font-size:18px; }

  .topbar-right {
    display:flex;
    align-items:center;
    gap:12px;
    position:relative;
  }

  .plan-badge{
    background:#fff3cf;
    color:#7a5a10;
    padding:6px 10px;
    border-radius:10px;
    font-size:13px;
    display:flex;
    align-items:center;
    gap:6px;
  }

  .profile {
    background: #0b2b2b;
    color: #fff;
    padding:6px 10px;
    border-radius:22px;
    display:flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    position:relative;
  }
  .profile .avatar {
    width:34px;height:34px;border-radius:50%;background:#fff;color:var(--dark);display:flex;align-items:center;justify-content:center;font-weight:700;
  }
  .profile .name { font-weight:700; font-size:14px; color: #fff; }

  /* language selector */
  .lang-switch { display:flex; gap:6px; align-items:center; }
  .lang-btn {
    background:transparent;
    border:1px solid rgba(255,255,255,0.22);
    color:#fff;
    padding:6px 8px;
    border-radius:6px;
    cursor:pointer;
    font-size:13px;
  }
  .lang-btn.active { background:#fff;color:var(--teal);border-color:#fff; font-weight:700; }

  /* page container below topbar */
  .page {
    display:flex;
    min-height: calc(100vh - var(--topbar-height));
    margin-top: var(--topbar-height); /* push below fixed topbar */
  }

  /* sidebar - desktop persistent, mobile slide-in */
  .sidebar {
    width:var(--sidebar-width);
    background: #f9fbfc;
    border-right:1px solid #ebeff0;
    padding:18px;
    transform: translateX(-360px);
    transition: transform .22s ease, box-shadow .22s ease;
    position:fixed;
    left:0;
    top:var(--topbar-height); /* sit below topbar */
    bottom:0;
    z-index:90;
    overflow:auto;
  }
  .sidebar.open { transform: translateX(0); box-shadow: 2px 0 24px rgba(8,52,54,0.08); }

  /* When on wide screens, show sidebar inline and make it non-overlaying */
  @media (min-width: calc(var(--breakpoint) + 1px)) {
    .sidebar {
      position:relative;
      transform:none;
      box-shadow:none;
      height: auto;
      top:0;
      left:0;
      z-index:10;
      max-height:none;
    }
    .sidebar.open { transform:none; box-shadow:none; }
  }

  .nav-section { margin-top:6px; }
  .nav-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-radius:8px;
    cursor:pointer;
    color:#08343a;
    margin-bottom:6px;
  }
  .nav-item:hover{ background: #eef6f7; }

  .hamburger{
    width:40px;height:40px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;border:none;color:#fff;font-size:22px;
  }

  /* sidebar backdrop for mobile */
  .sidebar-backdrop {
    position:fixed;
    inset:var(--topbar-height) 0 0 0; /* sit below topbar */
    background: rgba(0,0,0,0.35);
    display:none;
    z-index:85;
    transition: opacity .18s ease;
  }
  .sidebar-backdrop.show { display:block; }

  /* main content */
  .content {
    flex:1;
    padding:32px;
    transition: margin-left .22s ease;
    width:100%;
  }

  /* when desktop and sidebar visible, push content */
  @media (min-width: calc(var(--breakpoint) + 1px)) {
    .content.shifted { margin-left: var(--sidebar-width); }
  }

  .page-title {
    text-align:center;
    color:var(--dark);
    font-weight:800;
    font-size:28px;
    margin-top:6px;
    margin-bottom:18px;
  }

  /* cards area placeholder */
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap:20px;
    max-width:1100px;
    margin:22px auto 0;
  }
  .card {
    background:var(--card-bg);
    border-radius:10px;
    padding:18px;
    box-shadow:0 6px 18px rgba(8,52,54,0.03);
    min-height:120px;
  }
  .card h4{ margin:0 0 8px 0; color:var(--dark); }
  .card p{ margin:0;color:#556971; font-size:14px }

  /* profile dropdown */
  .profile-menu{
    position:absolute;
    right:18px;
    top:calc(var(--topbar-height));
    background:#fff;
    border:1px solid #e6eef0;
    border-radius:8px;
    min-width:180px;
    box-shadow:0 6px 20px rgba(8,52,54,0.08);
    display:none;
    z-index:130;
  }
  .profile-menu.open{ display:block; }
  .profile-menu button{
    width:100%;
    border:none;
    background:transparent;
    padding:10px 12px;
    text-align:left;
    cursor:pointer;
  }
  .profile-menu button:hover{ background:#f2f8f9; }

  /* activity submenu inside sidebar */
  .sublist { padding-left:6px; margin-top:6px; display:none; }
  .sublist.open { display:block; }
  .sublist .subitem {
    display:block;
    padding:8px 10px;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    color:#2b4d50;
    text-decoration:none;
  }
  .sublist .subitem:hover { background:#eef6f7; }
  .sublist .subitem:focus { outline:2px solid #bfeef7; }

  /* responsive tweaks */
  @media (max-width:900px){
    .content { padding:18px; }
    .page-title { font-size:20px; text-align:left; }
    .brand .title { display:none; } /* compact logo on mobile */
    .plan-badge { display:none; }   /* hide large badge on small screens */
    .profile .name { display:none; } /* compact profile on mobile */
  }

  /* micro accessibility/visual */
  button:focus { outline:3px solid rgba(14,127,168,0.18); outline-offset:2px; }
  a { color:inherit; text-decoration:none; }
</style>
</head>
<body>
  <div class="topbar" role="banner">
    <div style="display:flex;align-items:center;gap:14px">
      <button id="hamburger" class="hamburger" title="Open menu" aria-label="Open menu" aria-controls="sidebar" aria-expanded="false">
        ☰
      </button>
      <div class="brand" aria-hidden="true">
        <img src="logo.png" alt="logo" />
        <div class="title" data-i18n="brand">NeuroHue</div>
      </div>
    </div>

    <div class="topbar-right" style="position:relative">
      <div class="plan-badge" id="planBadge" aria-hidden="true" data-i18n="planBadge">Institutional Plan</div>

      <div class="lang-switch" aria-label="Language">
        <button class="lang-btn" id="lang-en" data-lang="en">EN</button>
        <button class="lang-btn" id="lang-tl" data-lang="tl">TL</button>
        <button class="lang-btn" id="lang-bis" data-lang="bisaya">CEB</button>
      </div>

      <div id="profileBtn" class="profile" title="Account" aria-haspopup="true" aria-expanded="false">
        <div class="avatar" id="avatar"></div>
        <div class="name" id="topUsername"></div>
      </div>

      <!-- small profile dropdown -->
      <div id="profileMenu" class="profile-menu" aria-hidden="true">
        <button id="viewProfileBtn" data-i18n="viewProfile">View Profile</button>
        <button id="goToAssess" data-i18n="goToAssess">Initial Assessment</button>
        <button id="logoutBtn" data-i18n="logout">Log Out</button>
      </div>
    </div>
  </div>

  <div class="page">
    <!-- mobile backdrop -->
    <div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true" tabindex="-1"></div>

    <aside id="sidebar" class="sidebar" aria-hidden="true" aria-label="Main menu">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong style="font-size:14px" data-i18n="menu">Menu</strong>
        <small style="color:#6b8e90" data-i18n="userActions">User Actions</small>
      </div>

      <div class="nav-section">
        <div class="nav-item" id="navRoutine" role="button" tabindex="0" title="Go to Routines">
          <div data-i18n="routine">Routine</div>
          <div style="font-size:13px;color:#6b8e90">⤴</div>
        </div>

        <div class="nav-item" id="activityToggle" role="button" aria-expanded="false" tabindex="0">
          <div data-i18n="activity">Activity</div>
          <div id="activityToggleIcon" style="font-size:13px;color:#6b8e90">▸</div>
        </div>

        <div id="activitySub" class="sublist" aria-hidden="true" role="menu">
          <a class="subitem" data-activity="gross" href="gross.html" role="menuitem" tabindex="-1" data-i18n="gross">Gross Motor Skills</a>
          <a class="subitem" data-activity="fine" href="fine.html" role="menuitem" tabindex="-1" data-i18n="fine">Fine Motor Skills</a>
          <a class="subitem" data-activity="speech" href="speech.html" role="menuitem" tabindex="-1" data-i18n="speech">Speech &amp; Learning</a>
          <a class="subitem" data-activity="cognitive" href="cognitive.html" role="menuitem" tabindex="-1" data-i18n="cognitive">Cognitive &amp; Learning</a>
          <a class="subitem" data-activity="behavior" href="behavior.html" role="menuitem" tabindex="-1" data-i18n="behavior">Behavior &amp; Social Skills</a>
        </div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid #eef4f5" />
      <div style="font-size:13px;color:#5f7a7c" data-i18n="summary">Summary</div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnProgress" style="padding:8px 12px;border-radius:8px;border:1px solid #e6eef0;background:#fff;color:#2b4d50;cursor:pointer" data-i18n="progress">Progress</button>
        <button id="btnReport" style="padding:8px 12px;border-radius:8px;border:1px solid #e6eef0;background:#fff;color:#2b4d50;cursor:pointer" data-i18n="report">Report</button>
      </div>
    </aside>

    <main class="content" role="main" id="mainContent">
      <div class="page-title" data-i18n="dashboard">Dashboard</div>

      <div class="grid" id="dashboardGrid">
        <div class="card">
          <h4 data-i18n="todaysRoutinesTitle">Today's Routines</h4>
          <p id="todaysRoutines" data-i18n="youHaveTasks">You have 0 tasks scheduled for today.</p>
        </div>

        <div class="card">
          <h4 data-i18n="recentActivityTitle">Recent Activity</h4>
          <p id="recentActivity" data-i18n="noActivity">No recorded activity yet.</p>
        </div>

        <div class="card">
          <h4 data-i18n="initialAssessmentTitle">Initial Assessment</h4>
          <p data-i18n="initialAssessmentBody">Complete the initial progress assessment to personalize recommendations.</p>
        </div>

        <div class="card">
          <h4 data-i18n="subscriptionTitle">Subscription</h4>
          <p id="subInfo" data-i18n="planActive">Institutional Plan — active</p>
        </div>
      </div>
    </main>
  </div>

<script>
  // small helpers
  function $(id){ return document.getElementById(id); }

  // translations (English, Tagalog (tl), Bisaya/Cebuano)
  const I18N = {
    en: {
      brand: "NeuroHue",
      planBadge: "Institutional Plan",
      viewProfile: "View Profile",
      goToAssess: "Initial Assessment",
      logout: "Log Out",
      menu: "Menu",
      userActions: "User Actions",
      routine: "Routine",
      activity: "Activity",
      gross: "Gross Motor Skills",
      fine: "Fine Motor Skills",
      speech: "Speech & Learning",
      cognitive: "Cognitive & Learning",
      behavior: "Behavior & Social Skills",
      summary: "Summary",
      progress: "Progress",
      report: "Report",
      dashboard: "Dashboard",
      todaysRoutinesTitle: "Today's Routines",
      youHaveTasks: "You have {n} tasks scheduled for today.",
      recentActivityTitle: "Recent Activity",
      noActivity: "No recorded activity yet.",
      initialAssessmentTitle: "Initial Assessment",
      initialAssessmentBody: "Complete the initial progress assessment to personalize recommendations.",
      subscriptionTitle: "Subscription",
      planActive: "{plan} — active",
      totalUsers: "Total users: {count}"
    },
    tl: { // Tagalog
      brand: "NeuroHue",
      planBadge: "Institutional Plan",
      viewProfile: "Tingnan ang Profile",
      goToAssess: "Paunang Pagsusuri",
      logout: "Mag-log Out",
      menu: "Menu",
      userActions: "Mga Gawain ng User",
      routine: "Rutin",
      activity: "Aktibidad",
      gross: "Gross Motor Skills",
      fine: "Fine Motor Skills",
      speech: "Pagsasalita at Pagkatuto",
      cognitive: "Cognitive at Pagkatuto",
      behavior: "Pag-uugali at Sosyal na Kasanayan",
      summary: "Buod",
      progress: "Progreso",
      report: "Ulat",
      dashboard: "Dashboard",
      todaysRoutinesTitle: "Mga Rutin Ngayon",
      youHaveTasks: "Mayroong {n} gawain naka-iskedyul para sa araw na ito.",
      recentActivityTitle: "Kamakailang Aktibidad",
      noActivity: "Walang naitalang aktibidad.",
      initialAssessmentTitle: "Paunang Pagsusuri",
      initialAssessmentBody: "Kumpletuhin ang paunang pagsusuri para sa mas personalisadong rekomendasyon.",
      subscriptionTitle: "Subscription",
      planActive: "{plan} — aktibo",
      totalUsers: "Kabuuang gumagamit: {count}"
    },
    bisaya: { // Bisaya (Cebuano-like)
      brand: "NeuroHue",
      planBadge: "Institutional Plan",
      viewProfile: "Tan-awon ang Profile",
      goToAssess: "Pangunang Pagtasa",
      logout: "Pag-log Out",
      menu: "Menu",
      userActions: "Mga Buhat sa User",
      routine: "Rutin",
      activity: "Kalihukan",
      gross: "Gross Motor Skills",
      fine: "Fine Motor Skills",
      speech: "Pulong ug Pagkat-on",
      cognitive: "Cognitive ug Pagkat-on",
      behavior: "Pamatasan ug Sosyal nga Kahanas",
      summary: "Sumaryo",
      progress: "Progreso",
      report: "Report",
      dashboard: "Dashboard",
      todaysRoutinesTitle: "Mga Rutin Karon",
      youHaveTasks: "Aduna kay {n} buhat nga naka-iskedyul karong adlawa.",
      recentActivityTitle: "Bag-ong Kalihukan",
      noActivity: "Walay narekord nga kalihukan karon.",
      initialAssessmentTitle: "Pangunang Pagtasa",
      initialAssessmentBody: "Kompletuha ang pangunang pagtasa aron ma-personalize ang mga rekomendasyon.",
      subscriptionTitle: "Subscription",
      planActive: "{plan} — aktibo",
      totalUsers: "Total nga users: {count}"
    }
  };

  // returns translated string for key and optional vars
  function t(key, vars = {}) {
    const lang = currentLang || 'en';
    const map = (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : (I18N.en[key] || '');
    let out = map;
    // substitute {name} placeholders
    for (const k in vars) {
      out = out.replace(new RegExp('\\{' + k + '\\}', 'g'), String(vars[k]));
    }
    return out;
  }

  // apply translations to all elements with data-i18n
  function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      // some elements contain dynamic placeholders or need special handling
      if (!key) return;
      // dynamic cases by id
      if (el.id === 'todaysRoutines') {
        // get number from stored or demo value; default 0
        const n = window._demoTasksCount ?? 0;
        el.textContent = t('youHaveTasks', { n });
        return;
      }
      if (el.id === 'recentActivity') {
        // demo activity string (static for now)
        const demo = window._demoRecentActivity ?? t('noActivity');
        el.textContent = demo;
        return;
      }
      if (key === 'planBadge') {
        // show plan name if stored
        const plan = localStorage.getItem('planName') || el.textContent || 'Plan';
        // keep plan name for planActive too
        window._currentPlanName = plan;
        el.textContent = t('planBadge') === 'Institutional Plan' ? plan : t('planBadge');
        return;
      }
      if (key === 'planActive' || el.id === 'subInfo') {
        const plan = window._currentPlanName || localStorage.getItem('planName') || 'Institutional Plan';
        el.textContent = t('planActive', { plan });
        return;
      }
      // default: set translated text
      el.textContent = t(key);
    });

    // update page title (document title)
    document.title = t('dashboard') + ' — NeuroHue';
    // update language button active state
    document.querySelectorAll('.lang-btn').forEach(b => {
      const lang = b.dataset.lang;
      b.classList.toggle('active', lang === currentLang);
    });
  }

  // language management
  let currentLang = localStorage.getItem('nh_lang') || 'en';
  function setLanguage(lang) {
    if (!I18N[lang]) lang = 'en';
    currentLang = lang;
    localStorage.setItem('nh_lang', lang);
    applyTranslations();
  }

  // small user loader
  function loadStoredUser() {
    const raw = localStorage.getItem('user') ?? sessionStorage.getItem('user')
             ?? localStorage.getItem('currentUser') ?? sessionStorage.getItem('currentUser')
             ?? localStorage.getItem('current_user') ?? sessionStorage.getItem('current_user');

    if (!raw) {
      const uname = localStorage.getItem('username') ?? sessionStorage.getItem('username');
      const uid = localStorage.getItem('user_id') ?? sessionStorage.getItem('user_id') ?? localStorage.getItem('userId') ?? sessionStorage.getItem('userId');
      return { id: uid || null, username: uname || null, raw: null };
    }

    try {
      const parsed = JSON.parse(raw);
      const userObj = parsed.user ?? parsed;
      const id = userObj.id ?? userObj.user_id ?? parsed.user_id ?? parsed.id ?? null;
      const username = userObj.username ?? userObj.name ?? parsed.username ?? parsed.email ?? null;
      return { id: id, username: username, raw: parsed };
    } catch (e) {
      return { id: null, username: raw, raw: raw };
    }
  }

  // use loaded stored user to show top username and avatar (or fallback)
  const stored = loadStoredUser();
  const username = stored.username || localStorage.getItem('username') || sessionStorage.getItem('username') || 'User';
  const displayName = username || 'User';
  $('topUsername').textContent = displayName;
  $('avatar').textContent = displayName.charAt(0).toUpperCase();

  // Sidebar and backdrop
  const hamburger = $('hamburger');
  const sidebar = $('sidebar');
  const sidebarBackdrop = $('sidebarBackdrop');
  const mainContent = $('mainContent');
  let sidebarOpen = false;

  function setSidebar(open, opts = {}) {
    sidebarOpen = !!open;
    sidebar.classList.toggle('open', sidebarOpen);
    sidebar.setAttribute('aria-hidden', String(!sidebarOpen));
    hamburger.setAttribute('aria-expanded', String(sidebarOpen));
    // backdrop should show only on small screens
    if (window.innerWidth <= 900) {
      if (sidebarOpen) {
        sidebarBackdrop.classList.add('show');
        sidebarBackdrop.setAttribute('aria-hidden', 'false');
      } else {
        sidebarBackdrop.classList.remove('show');
        sidebarBackdrop.setAttribute('aria-hidden', 'true');
      }
    } else {
      sidebarBackdrop.classList.remove('show');
      sidebarBackdrop.setAttribute('aria-hidden', 'true');
    }

    // shift content for desktop when sidebar is effectively part of layout
    if (window.innerWidth > 900) {
      if (sidebarOpen) mainContent.classList.add('shifted');
      else mainContent.classList.remove('shifted');
    } else {
      mainContent.classList.remove('shifted');
    }

    if (opts.shouldFocusToggle) hamburger.focus();
  }

  // initial open state and initial language
  window.addEventListener('DOMContentLoaded', () => {
    setSidebar(window.innerWidth > 900);
    // wire language buttons
    document.querySelectorAll('.lang-btn').forEach(b => {
      b.addEventListener('click', () => {
        setLanguage(b.dataset.lang);
      });
    });
    // initialize language button state & translations
    setLanguage(currentLang);

    // initialize activity submenu keyboard focus state
    document.querySelectorAll('#activitySub .subitem').forEach(a => a.tabIndex = -1);
  });

  // toggle button
  hamburger.addEventListener('click', () => {
    setSidebar(!sidebarOpen, { shouldFocusToggle: true });
  });

  // clicking backdrop closes sidebar on mobile
  sidebarBackdrop.addEventListener('click', () => setSidebar(false));

  // Close sidebar when navigation item clicked on mobile (so user sees page)
  document.querySelectorAll('#sidebar .subitem, #sidebar .nav-item').forEach(el => {
    el.addEventListener('click', (e) => {
      if (window.innerWidth <= 900) setSidebar(false);
    });
  });

  // Profile dropdown
  const profileBtn = $('profileBtn');
  const profileMenu = $('profileMenu');
  let profileOpen = false;
  profileBtn.addEventListener('click', (e) => {
    profileOpen = !profileOpen;
    profileMenu.classList.toggle('open', profileOpen);
    profileMenu.setAttribute('aria-hidden', String(!profileOpen));
    profileBtn.setAttribute('aria-expanded', String(profileOpen));
  });

  // Close profile menu on outside click
  document.addEventListener('click', (e) => {
    if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
      profileOpen = false;
      profileMenu.classList.remove('open');
      profileMenu.setAttribute('aria-hidden', 'true');
      profileBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // Logout: only in profile dropdown now
  function doLogout(){
    const keys = [
      'user','currentUser','current_user','username',
      'user_id','userId','userid','authToken','token',
      'planName','matchShapesCompleted','matchShapesInProgress',
      'behaviorChecklistCompleted','nh_lang'
    ];
    keys.forEach(k=>{ try { localStorage.removeItem(k); } catch(e){}; try { sessionStorage.removeItem(k); } catch(e){}; });
    window.location.href = 'signin.html';
  }
  $('logoutBtn')?.addEventListener('click', doLogout);

  // ROUTINE nav
  const navRoutine = $('navRoutine');
  if (navRoutine) {
    navRoutine.addEventListener('click', ()=> {
      window.location.href = 'routine.html';
    });
  }

  // Profile menu quick links
  $('viewProfileBtn')?.addEventListener('click', ()=>{ window.location.href = 'profile.html'; });
  $('goToAssess')?.addEventListener('click', ()=>{ window.location.href = 'initial_progress_assessment.html'; });

  // Activity toggle and subitems
  const activityToggle = $('activityToggle');
  const activitySub = $('activitySub');
  const activityToggleIcon = $('activityToggleIcon');
  let activityOpen = false;
  if (activityToggle) {
    activityToggle.addEventListener('click', () => {
      activityOpen = !activityOpen;
      activitySub.classList.toggle('open', activityOpen);
      activityToggle.setAttribute('aria-expanded', String(activityOpen));
      activityToggleIcon.textContent = activityOpen ? '▾' : '▸';
      activitySub.querySelectorAll('.subitem').forEach(a => a.tabIndex = activityOpen ? 0 : -1);
      if (activityOpen) {
        const first = activitySub.querySelector('.subitem');
        if (first) first.focus();
      } else {
        activityToggle.focus();
      }
    });

    activityToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.code === 'Space') {
        e.preventDefault();
        activityToggle.click();
      }
    });
  }

  // Keyboard navigation in submenu
  activitySub?.addEventListener('keydown', (e) => {
    const items = Array.from(activitySub.querySelectorAll('.subitem'));
    if (!items.length) return;
    const idx = items.indexOf(document.activeElement);
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const next = items[(idx + 1) % items.length];
      next.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      const prev = items[(idx - 1 + items.length) % items.length];
      prev.focus();
    } else if (e.key === 'Home') {
      e.preventDefault();
      items[0].focus();
    } else if (e.key === 'End') {
      e.preventDefault();
      items[items.length - 1].focus();
    }
  });

  // Placeholder demo loader (use translations)
  function loadDemo() {
    const routinesToday = 3;
    window._demoTasksCount = routinesToday;
    window._demoRecentActivity = t('recentActivityTitle') + ': Matched 2 shapes • Submitted checklist';
    window._currentPlanName = localStorage.getItem('planName') || 'Institutional Plan';
    applyTranslations();
  }
  loadDemo();

  // Responsive behavior when window resizes
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (window.innerWidth > 900) {
        setSidebar(true);
      } else {
        setSidebar(sidebarOpen);
      }
    }, 120);
  });

  // Accessibility: close sidebar on Escape for mobile
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (profileOpen) {
        profileOpen = false;
        profileMenu.classList.remove('open');
        profileMenu.setAttribute('aria-hidden', 'true');
        profileBtn.setAttribute('aria-expanded', 'false');
      }
      if (window.innerWidth <= 900 && sidebarOpen) setSidebar(false);
    }
  });
</script>
</body>
</html>
