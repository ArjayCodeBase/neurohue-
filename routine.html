<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Routines | NeuroHue</title>
<style>
  :root{
    --teal:#268ea6;
    --dark:#093c44;
    --card-bg:#ffffff;
    --muted:#f3f6f7;
    --gap:14px;
  }
  *{box-sizing:border-box}
  html,body { height:100%; }
  body{
    margin:0;
    font-family: "Arial",sans-serif;
    background:#f5f7fa;
    color:#08343a;
    min-height:100vh;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Topbar */
  .topbar{
    height:64px;
    background:var(--teal);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 18px;
    color:#fff;
    box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    position:sticky;
    top:0;
    z-index:60;
  }
  .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
  .brand img{ height:34px; width:34px; border-radius:6px; object-fit:cover }
  .brand .title { font-size:18px; white-space:nowrap; }

  .topbar-right { display:flex; align-items:center; gap:12px; position:relative; }

  .plan-badge{ background:#fff3cf; color:#7a5a10; padding:6px 10px; border-radius:10px; font-size:13px; display:flex; align-items:center; gap:6px; white-space:nowrap; }

  .profile { background: #0b2b2b; color: #fff; padding:6px 10px; border-radius:22px; display:flex; align-items:center; gap:10px; cursor:pointer; position:relative; }
  .profile .avatar { width:34px;height:34px;border-radius:50%;background:#fff;color:var(--dark);display:flex;align-items:center;justify-content:center;font-weight:700; }
  .profile .name { font-weight:700; font-size:14px; }

  .hamburger{ width:34px;height:34px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;border:none;color:#fff;font-size:22px; }

  /* app layout */
  .app { display:flex; min-height: calc(100vh - 64px); height: calc(100vh - 64px); overflow:hidden; }

  /* sidebar */
  .sidebar {
    width:280px;
    background: #f9fbfc;
    border-right:1px solid #ebeff0;
    padding:18px;
    transition: transform .22s ease;
    position:relative;
    z-index:30;
    flex-shrink:0;
  }
  /* for small screens we'll toggle this class */
  .sidebar.hidden { transform: translateX(-110%); box-shadow: none; position:fixed; top:64px; left:0; height: calc(100vh - 64px); overflow:auto; }
  .sidebar.open { transform: translateX(0); box-shadow: 2px 0 14px rgba(0,0,0,0.05); position:fixed; top:64px; left:0; height: calc(100vh - 64px); overflow:auto; }

  .nav-section { margin-top:6px; }
  .nav-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:8px; cursor:pointer; color:#08343a; margin-bottom:6px; }
  .nav-item:hover{ background: #eef6f7; }

  /* backdrop for mobile sidebar */
  #backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.28); display:none; z-index:29; transition:opacity .18s; opacity:0; }
  #backdrop.show { display:block; opacity:1; }

  /* main content */
  .content { flex:1; padding:24px; overflow:auto; min-width:0; }

  .page-title { text-align:left; color:var(--dark); font-weight:800; font-size:22px; margin-top:6px; margin-bottom:12px; }

  /* routine UI */
  .controls { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; align-items:center; }
  .card { background:var(--card-bg); border-radius:8px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .card-left { display:flex; gap:12px; align-items:center; min-width:0; }
  .thumb { width:84px; height:84px; border-radius:10px; background:#f4f6f7; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #eee; flex-shrink:0; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .meta { font-size:13px; color:#333; min-width:0; }
  .title { font-weight:700; margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .small { font-size:12px; color:#666; display:block; }
  .btn { background:#093c44; color:#fff; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
  .btn.secondary { background:#eee; color:#093c44; border:1px solid #ddd; }
  .status { font-weight:700; padding:6px 10px; border-radius:20px; margin-right:8px; text-align:center; min-width:72px; text-transform:capitalize; }
  .status.Inprogress { background:#fff1f0; color:#c0392b; border:1px solid #f5c6c4;}
  .status.Done { background:#ecf9f0; color:#16a34a; border:1px solid #c5eacb;}
  .status.Miss { background:#fff6e6; color:#b36f00; border:1px solid #f1d9b0;}
  .status.Due { background:#fff8e6; color:#c67d00; border:1px solid #f1e3c8; }

  form.create { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; width:100%; }
  input, select { padding:8px; border-radius:6px; border:1px solid #ccc; background:#fff; }

  .grid-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); gap:18px; margin-top:16px; }

  /* modal */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:999; }
  .modal { background:#fff; border-radius:10px; width:520px; max-width:92%; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.15); }
  .modal .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
  .modal .thumb-preview { width:90px; height:90px; border-radius:8px; background:#f3f6f7; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #eee; }
  .modal .thumb-preview img { width:100%; height:100%; object-fit:cover; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  .muted { color:#666; font-size:13px; }

  .profile-menu{ position:absolute; right:18px; top:64px; background:#fff; border:1px solid #e6eef0; border-radius:8px; min-width:180px; box-shadow:0 6px 20px rgba(8,52,54,0.08); display:none; z-index:40; }
  .profile-menu.open{ display:block; }
  .profile-menu button{ width:100%; border:none; background:transparent; padding:10px 12px; text-align:left; cursor:pointer; }
  .profile-menu button:hover{ background:#f2f8f9; }

  .sublist { padding-left:6px; margin-top:6px; display:none; }
  .sublist.open { display:block; }
  .sublist .subitem { display:block; padding:8px 10px; border-radius:6px; cursor:pointer; font-size:14px; color:#2b4d50; text-decoration:none; }
  .sublist .subitem:hover { background:#eef6f7; }
  .sublist .subitem:focus { outline:2px solid #bfeef7; }

  /* responsiveness */
  @media (max-width:900px){
    .sidebar { position:fixed; top:64px; left:0; height: calc(100vh - 64px); transform: translateX(-110%); width:260px; overflow:auto; }
    .sidebar.hidden { transform: translateX(-110%); }
    .sidebar.open { transform: translateX(0); }
    #backdrop { display:block; opacity:0; }
    #backdrop.show { opacity:1; }
    .content { padding:18px; }
    .brand .title { display:none; }
    .plan-badge { display:none; }
    .card { flex-direction:column; align-items:flex-start; }
    .card-actions { width:100%; display:flex; gap:8px; margin-top:8px; justify-content:flex-start; }
    .thumb { width:70px; height:70px; }
    .page-title { font-size:20px; }
  }

  @media (max-width:420px){
    .thumb { width:64px; height:64px; }
    .title { font-size:15px; }
    .card { padding:10px; gap:8px; }
    .grid-cards { gap:12px; }
  }
</style>
</head>
<body>
  <div class="topbar" role="banner">
    <div style="display:flex;align-items:center;gap:14px">
      <button id="hamburger" class="hamburger" title="Menu" aria-label="Open menu">☰</button>
      <div class="brand" aria-hidden="false">
        <img src="logo.png" alt="logo" />
        <div class="title">NeuroHue</div>
      </div>
    </div>

    <div class="topbar-right" style="position:relative">
      

      <div id="profileBtn" class="profile" title="Account" aria-haspopup="true" aria-expanded="false">
        <div class="avatar" id="avatar"></div>
        <div class="name" id="topUsername">User</div>
      </div>

      <div id="profileMenu" class="profile-menu" aria-hidden="true">
        <button id="viewProfileBtn">View Profile</button>
        <button id="goToAssess">Initial Assessment</button>
        <button id="logoutBtn">Log Out</button>
      </div>
    </div>
  </div>

  <div id="backdrop" aria-hidden="true"></div>

  <div class="app">
    <aside id="sidebar" class="sidebar hidden" aria-hidden="true">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong style="font-size:14px">Menu</strong>
        <small style="color:#6b8e90">User Actions</small>
      </div>

      <div class="nav-section">
        <div class="nav-item" id="navDashboard" role="button" tabindex="0" title="Go to Routines">
          <div>Dashboard</div>
          <div style="font-size:13px;color:#6b8e90">⤴</div>
        </div>

        <div class="nav-item" id="navRoutine" role="button" tabindex="0" title="Go to Routines">
          <div>Routine</div>
          <div style="font-size:13px;color:#6b8e90">⤴</div>
        </div>

        <div class="nav-item" id="activityToggle" role="button" aria-expanded="false" tabindex="0">
          <div>Activity</div>
          <div id="activityToggleIcon" style="font-size:13px;color:#6b8e90">▸</div>
        </div>

        <div id="activitySub" class="sublist" aria-hidden="true" role="menu">
          <a class="subitem" data-activity="gross" href="gross.html" role="menuitem" tabindex="-1">Gross Motor Skills</a>
          <a class="subitem" data-activity="fine" href="fine.html" role="menuitem" tabindex="-1">Fine Motor Skills</a>
          <a class="subitem" data-activity="speech" href="speech.html" role="menuitem" tabindex="-1">Speech &amp; Learning</a>
          <a class="subitem" data-activity="cognitive" href="cognitive.html" role="menuitem" tabindex="-1">Cognitive &amp; Learning</a>
          <a class="subitem" data-activity="behavior" href="behavior.html" role="menuitem" tabindex="-1">Behavior &amp; Social Skills</a>
        </div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid #eef4f5" />
      <div style="font-size:13px;color:#5f7a7c">Quick Links</div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button style="padding:8px 12px;border-radius:8px;border:1px solid #e6eef0;background:#fff;color:#2b4d50;cursor:pointer">Progress</button>
        <button style="padding:8px 12px;border-radius:8px;border:1px solid #e6eef0;background:#fff;color:#2b4d50;cursor:pointer">Reports</button>
      </div>
    </aside>

    <main class="content" role="main">
      <div class="page-title">Daily Routine</div>

      <!-- create routine -->
      <form id="createForm" class="create" onsubmit="event.preventDefault(); createRoutine()">
        <select id="category" required>
          <option value="">Category</option>
          <option>Sleeping</option>
          <option>Shower</option>
          <option>Breakfast</option>
          <option>Snack</option>
          <option>Lunch</option>
          <option>Dinner</option>
          <option>Other</option>
        </select>

        <input id="task" placeholder="Task (e.g. Snack, Breakfast)" required />
        <input id="time" type="time" required />
        <input id="imageFileCreate" type="file" accept="image/*" title="Optional image for this routine" />
        <button class="btn" type="submit">Create</button>
      </form>

      <div id="message" class="small" aria-live="polite"></div>

      <div class="grid-cards" id="list"></div>
    </main>
  </div>

  <!-- Edit modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal" role="document">
      <h3 id="modalTitle">Edit Routine</h3>
      <div class="row">
        <div class="thumb-preview" id="editPreview"><span class="muted">No image</span></div>
        <div style="flex:1">
          <label class="small">Category</label>
          <select id="editCategory">
            <option>Sleeping</option>
            <option>Shower</option>
            <option>Breakfast</option>
            <option>Snack</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Other</option>
          </select>
          <div style="height:8px"></div>
          <label class="small">Replace Image (optional)</label>
          <input id="imageFileEdit" type="file" accept="image/*" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label class="small">Task</label>
          <input id="editTask" />
        </div>
        <div style="width:130px">
          <label class="small">Time</label>
          <input id="editTime" type="time" />
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <div class="muted" id="editStatusHint"></div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" id="closeModal">Cancel</button>
        <button class="btn" id="saveEdit">Save changes</button>
      </div>
    </div>
  </div>

<script>
  const baseURL = "https://neurohue.onrender.com";

  // small helper
  function $(id){ return document.getElementById(id); }

  function loadStoredUser() {
    const raw = localStorage.getItem('user') ?? sessionStorage.getItem('user')
             ?? localStorage.getItem('currentUser') ?? sessionStorage.getItem('currentUser')
             ?? localStorage.getItem('current_user') ?? sessionStorage.getItem('current_user');

    if (!raw) {
      const uname = localStorage.getItem('username') ?? sessionStorage.getItem('username');
      const uid = localStorage.getItem('user_id') ?? sessionStorage.getItem('user_id') ?? localStorage.getItem('userId') ?? sessionStorage.getItem('userId');
      return { id: uid || null, username: uname || null, raw: null };
    }

    try {
      const parsed = JSON.parse(raw);
      const userObj = parsed.user ?? parsed;
      const id = userObj.id ?? userObj.user_id ?? parsed.user_id ?? parsed.id ?? null;
      const username = userObj.username ?? userObj.name ?? parsed.username ?? parsed.email ?? null;
      return { id: id, username: username, raw: parsed };
    } catch (e) {
      return { id: null, username: raw, raw: raw };
    }
  }

  const stored = loadStoredUser();
  const username = stored.username || localStorage.getItem('username') || sessionStorage.getItem('username') || 'User';
  const displayName = username || 'User';
  $('topUsername').textContent = displayName;
  $('avatar').textContent = displayName.charAt(0).toUpperCase();

  // Sidebar toggle + backdrop logic (keeps menus functional)
  const hamburger = $('hamburger');
  const sidebar = $('sidebar');
  const backdrop = $('backdrop');
  let sidebarOpen = false;

  function setSidebarOpen(open){
    sidebarOpen = !!open;
    // on small screens, we use classes to show/hide the sidebar
    if (window.innerWidth <= 900) {
      sidebar.classList.toggle('open', sidebarOpen);
      sidebar.classList.toggle('hidden', !sidebarOpen);
      sidebar.setAttribute('aria-hidden', String(!sidebarOpen));
      if (sidebarOpen) {
        backdrop.classList.add('show');
        backdrop.style.display = 'block';
        backdrop.setAttribute('aria-hidden', 'false');
      } else {
        backdrop.classList.remove('show');
        backdrop.style.display = 'none';
        backdrop.setAttribute('aria-hidden', 'true');
      }
    } else {
      // desktop: keep sidebar visible and ensure backdrop hidden
      sidebar.classList.remove('hidden');
      sidebar.classList.remove('open');
      sidebar.setAttribute('aria-hidden', 'false');
      backdrop.classList.remove('show');
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
    }
  }

  hamburger.addEventListener('click', ()=> setSidebarOpen(!sidebarOpen));
  backdrop.addEventListener('click', ()=> setSidebarOpen(false));

  // ensure correct default on initial load and when resizing
  function applyInitialSidebar() {
    if (window.innerWidth > 900) {
      sidebar.classList.remove('hidden');
      sidebar.classList.remove('open');
      sidebar.setAttribute('aria-hidden', 'false');
      backdrop.classList.remove('show');
      backdrop.style.display = 'none';
      sidebarOpen = true;
    } else {
      sidebar.classList.add('hidden');
      sidebar.classList.remove('open');
      sidebar.setAttribute('aria-hidden', 'true');
      backdrop.classList.remove('show');
      backdrop.style.display = 'none';
      sidebarOpen = false;
    }
  }
  window.addEventListener('resize', applyInitialSidebar);

  // Profile dropdown
  const profileBtn = $('profileBtn');
  const profileMenu = $('profileMenu');
  let profileOpen = false;
  profileBtn.addEventListener('click', (e) => {
    profileOpen = !profileOpen;
    profileMenu.classList.toggle('open', profileOpen);
    profileMenu.setAttribute('aria-hidden', String(!profileOpen));
    profileBtn.setAttribute('aria-expanded', String(profileOpen));
  });
  document.addEventListener('click', (e) => {
    if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
      profileOpen = false;
      profileMenu.classList.remove('open');
      profileMenu.setAttribute('aria-hidden', 'true');
      profileBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // quick actions
 function doLogout(){
  const keys = ['user','currentUser','current_user','username','user_id','userId','userid','authToken','token','planName'];
  keys.forEach(k=>{ try{ localStorage.removeItem(k); sessionStorage.removeItem(k); } catch(e){} });
  window.location.href = 'signin.html';
}
$('logoutBtn')?.addEventListener('click', doLogout);
  $('viewProfileBtn')?.addEventListener('click', ()=> window.location.href = 'profile.html');
  $('goToAssess')?.addEventListener('click', ()=> window.location.href = 'initial_progress_assessment.html');

  // nav links
  document.getElementById('navDashboard')?.addEventListener('click', ()=> window.location.href = 'dashboard.html');
  document.getElementById('navRoutine')?.addEventListener('click', ()=> {
    if (window.innerWidth <= 900) setSidebarOpen(false);
    else document.querySelector('main')?.scrollIntoView({behavior:'smooth'});
  });

  // activity toggle behaviour
  const activityToggle = $('activityToggle');
  const activitySub = $('activitySub');
  const activityToggleIcon = $('activityToggleIcon');
  let activityOpen = false;
  if (activityToggle) {
    activityToggle.addEventListener('click', () => {
      activityOpen = !activityOpen;
      activitySub.classList.toggle('open', activityOpen);
      activityToggle.setAttribute('aria-expanded', String(activityOpen));
      activityToggleIcon.textContent = activityOpen ? '▾' : '▸';
      activitySub.querySelectorAll('.subitem').forEach(a => a.tabIndex = activityOpen ? 0 : -1);
      if (activityOpen) {
        const first = activitySub.querySelector('.subitem');
        if (first) first.focus();
      } else {
        activityToggle.focus();
      }
    });
    activityToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.code === 'Space') { e.preventDefault(); activityToggle.click(); }
    });
  }
  document.querySelectorAll('#activitySub .subitem').forEach(a => a.tabIndex = -1);

  // Optionally set plan badge from storage
  const storedPlan = localStorage.getItem('planName') ?? sessionStorage.getItem('planName');
  if (storedPlan) document.getElementById('planBadge').textContent = storedPlan;

  // ----------------------
  // Routines logic (keeps your original behavior)
  // ----------------------
  function defaultCategoryImage(category){
    const map = {
      'Sleeping': 'images/eating.png',
      'Shower': 'images/cleaning.png',
      'Breakfast': 'images/sleeping.png',
      'Snack': 'images/exercising.png',
      'Lunch': 'images/working.png',
      'Dinner': 'images/therapy.png',
      'Other': 'images/other.png'
    };
    return map[category] || map['Other'];
  }
  function keyForRoutineImage(id){ return `routine_image_${id}`; }
  function saveRoutineImage(id, dataUrl){ try { localStorage.setItem(keyForRoutineImage(id), dataUrl); } catch(e){ console.warn('image save failed', e); } }
  function getRoutineImage(id){ return localStorage.getItem(keyForRoutineImage(id)); }
  function removeRoutineImage(id){ localStorage.removeItem(keyForRoutineImage(id)); }

  const listRoot = document.getElementById('list');
  const messageEl = document.getElementById('message');
  let currentRoutines = [];

  function parseStoredUser(){
    const raw = localStorage.getItem('user') ?? sessionStorage.getItem('user');
    if (raw) {
      try {
        const obj = JSON.parse(raw);
        if (obj && obj.id) return { id: obj.id, username: obj.username ?? obj.name ?? null };
        if (obj.user && obj.user.id) return { id: obj.user.id, username: obj.user.username ?? obj.user.name ?? null };
      } catch(e){}
    }
    const id = localStorage.getItem('user_id') ?? sessionStorage.getItem('user_id') ?? localStorage.getItem('userId') ?? sessionStorage.getItem('userId') ?? null;
    const username = localStorage.getItem('username') ?? sessionStorage.getItem('username') ?? null;
    if (!id) return null;
    return { id: isNaN(Number(id)) ? id : Number(id), username };
  }

  const currentUser = parseStoredUser();
  if (!currentUser || !currentUser.id) {
    window.location.href = 'signin.html';
  }

  async function fetchRoutines(){
    messageEl.textContent = 'Loading routines...';
    try {
      const res = await fetch(`${baseURL}/routines/${encodeURIComponent(currentUser.id)}`);
      if (!res.ok) throw new Error('Failed to load');
      const routines = await res.json();
      currentRoutines = routines;
      renderRoutines(routines);
      messageEl.textContent = '';
    } catch (err) {
      messageEl.textContent = 'Unable to fetch routines.';
      console.error(err);
    }
  }

  function renderRoutines(routines){
    listRoot.innerHTML = '';
    if (!routines || routines.length === 0) {
      listRoot.innerHTML = '<p class="small">No routines yet. Create one above.</p>';
      return;
    }

    routines.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card';

      const left = document.createElement('div');
      left.className = 'card-left';
      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const imgUrl = getRoutineImage(r.id) || (r.image ? r.image : defaultCategoryImage(r.category));
      const img = document.createElement('img');
      img.src = imgUrl;
      img.alt = r.category + ' image';
      thumb.appendChild(img);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<div class="title">${escapeHtml(r.task)}</div>
                        <div class="small">${escapeHtml(r.category)} • ${formatTime(r.time)}</div>`;

      left.appendChild(thumb);
      left.appendChild(meta);

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.alignItems = 'center';
      right.style.gap = '8px';

      const statusSpan = document.createElement('div');
      statusSpan.className = 'status ' + (r.status || 'Inprogress');
      statusSpan.textContent = r.status || 'Inprogress';

      const btnMarkDone = document.createElement('button');
      btnMarkDone.className = 'btn';
      btnMarkDone.textContent = 'Mark Done';
      btnMarkDone.onclick = () => markRoutine(r.id, 'Done');

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn secondary';
      btnEdit.textContent = 'Edit';
      btnEdit.onclick = () => openEditModal(r);

      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn secondary';
      btnDelete.style.marginLeft = '6px';
      btnDelete.textContent = 'Delete';
      btnDelete.onclick = () => deleteRoutine(r.id);

      right.appendChild(statusSpan);
      right.appendChild(btnMarkDone);
      right.appendChild(btnEdit);
      right.appendChild(btnDelete);

      card.appendChild(left);
      card.appendChild(right);
      listRoot.appendChild(card);
    });

    runAutoProgressCheck();
  }

  function escapeHtml(s){
    if (!s) return '';
    return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function formatTime(t){
    if (!t) return '';
    const [hh, mm] = t.split(':').map(Number);
    if (Number.isNaN(hh)) return t;
    const am = hh < 12;
    const h12 = ((hh + 11) % 12) + 1;
    return `${String(h12).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${am ? 'AM' : 'PM'}`;
  }

  async function createRoutine(){
    const category = document.getElementById('category').value;
    const task = document.getElementById('task').value.trim();
    const time = document.getElementById('time').value;
    const file = document.getElementById('imageFileCreate').files[0];

    if (!category || !task || !time) {
      messageEl.textContent = 'Please complete all create fields.';
      return;
    }
    messageEl.textContent = 'Creating...';

    const doCreate = async (fileDataUrlForCreate) => {
      const payload = { user_id: currentUser.id, category, task, time };
      try {
        const res = await fetch(`${baseURL}/routines`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'Create failed');
        }
        const created = await res.json();
        if (fileDataUrlForCreate) {
          saveRoutineImage(created.id, fileDataUrlForCreate);
        }
        document.getElementById('task').value = '';
        document.getElementById('category').value = '';
        document.getElementById('time').value = '';
        document.getElementById('imageFileCreate').value = '';
        messageEl.textContent = 'Created.';
        fetchRoutines();
        if (window.innerWidth <= 900) setSidebarOpen(false);
      } catch (err) {
        messageEl.textContent = 'Failed to create.';
        console.error(err);
      }
    };

    let fileDataUrlForCreate = null;
    if (file) {
      try {
        fileDataUrlForCreate = await readFileAsDataURL(file);
      } catch(e) {
        console.warn('file read failed', e);
        fileDataUrlForCreate = null;
      }
    }

    doCreate(fileDataUrlForCreate);
  }

  function readFileAsDataURL(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result));
      fr.onerror = () => reject(new Error('file read error'));
      fr.readAsDataURL(file);
    });
  }

  async function deleteRoutine(routineId){
    if (!confirm('Delete this routine?')) return;
    try {
      const res = await fetch(`${baseURL}/routine/${encodeURIComponent(routineId)}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed');
      removeRoutineImage(routineId);
      fetchRoutines();
    } catch (err) {
      messageEl.textContent = 'Failed to delete.';
      console.error(err);
    }
  }

  async function markRoutine(routineId, status){
    try {
      const res = await fetch(`${baseURL}/routine/${encodeURIComponent(routineId)}/mark`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status })
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || 'Mark failed');
      }
      await res.json();
      fetchRoutines();
    } catch (err) {
      messageEl.textContent = 'Failed to update status.';
      console.error(err);
    }
  }

  function runAutoProgressCheck(){
    const now = new Date();
    if (!currentRoutines || !Array.isArray(currentRoutines)) return;

    currentRoutines.forEach(r => {
      if (!r || (r.status || 'Inprogress') !== 'Inprogress') return;
      const parts = (r.time || "").split(':');
      if (parts.length < 2) return;
      const hh = parseInt(parts[0], 10);
      const mm = parseInt(parts[1], 10);
      if (Number.isNaN(hh) || Number.isNaN(mm)) return;

      const sched = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
      const diffMinutes = Math.floor((now - sched) / 60000);

      if (diffMinutes >= 30) {
        markRoutine(r.id, 'Miss');
      } else {
        // keep UI updated by re-fetch when appropriate
      }
    });
  }

  setInterval(runAutoProgressCheck, 20000);

  // edit modal
  let editingId = null;
  const modalBackdrop = document.getElementById('modal');
  const editPreview = document.getElementById('editPreview');
  const editCategory = document.getElementById('editCategory');
  const editTask = document.getElementById('editTask');
  const editTime = document.getElementById('editTime');
  const imageFileEdit = document.getElementById('imageFileEdit');
  const editStatusHint = document.getElementById('editStatusHint');

  function openEditModal(routine){
    editingId = routine.id;
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden', 'false');

    editCategory.value = routine.category || 'Other';
    editTask.value = routine.task || '';
    editTime.value = routine.time || '';
    editStatusHint.textContent = `Current status: ${routine.status || 'Inprogress'}`;

    const stored = getRoutineImage(routine.id);
    setPreviewImage(stored || (routine.image ? routine.image : defaultCategoryImage(routine.category)));
    imageFileEdit.value = '';
  }

  function setPreviewImage(url){
    editPreview.innerHTML = '';
    if (!url) {
      const span = document.createElement('span'); span.className='muted'; span.textContent = 'No image';
      editPreview.appendChild(span);
      return;
    }
    const img = document.createElement('img'); img.src = url; img.alt = 'preview';
    editPreview.appendChild(img);
  }

  $('closeModal').addEventListener('click', ()=>{ modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden', 'true'); editingId = null; });

  $('saveEdit').addEventListener('click', async ()=>{ 
    if (!editingId) return;
    const newTask = editTask.value.trim();
    const newTime = editTime.value;
    const newCategory = editCategory.value;
    const newFile = imageFileEdit.files[0];

    if (!newTask || !newTime) {
      alert('Please provide task and time.');
      return;
    }

    let newDataUrl = null;
    if (newFile) {
      try { newDataUrl = await readFileAsDataURL(newFile); saveRoutineImage(editingId, newDataUrl); } catch(e){ console.warn('image read failed', e); }
    }

    const payload = { task: newTask, time: newTime };

    try {
      const resp = await fetch(`${baseURL}/routine/${encodeURIComponent(editingId)}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        try {
          const alt = { user_id: currentUser.id, category: newCategory, task: newTask, time: newTime };
          const r2 = await fetch(`${baseURL}/routine/${encodeURIComponent(editingId)}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(alt)
          });
          if (!r2.ok) throw new Error('Update failed');
        } catch (err) {
          throw err;
        }
      }

      if (newDataUrl) setPreviewImage(newDataUrl);
      else if (!getRoutineImage(editingId)) setPreviewImage(defaultCategoryImage(newCategory));

      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden', 'true');
      editingId = null;

      setTimeout(fetchRoutines, 250);
    } catch (err) {
      console.error('Update failed', err);
      alert('Failed to update routine. Check console for details.');
    }
  });

  modalBackdrop.addEventListener('click', (e)=>{
    if (e.target === modalBackdrop) {
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden', 'true');
      editingId = null;
    }
  });

  imageFileEdit.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if (!f) return;
    try { const dataUrl = await readFileAsDataURL(f); setPreviewImage(dataUrl); } catch(e){ console.warn('read fail', e); }
  });

  // initial load
  window.addEventListener('DOMContentLoaded', ()=>{
    applyInitialSidebar();
    fetchRoutines();
  });

</script>
</body>
</html>
